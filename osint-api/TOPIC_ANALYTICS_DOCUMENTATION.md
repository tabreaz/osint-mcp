# Topic Analytics Integration Documentation

## Overview
This document describes the complete topic analytics integration for the OSINT Monitoring API, including LLM-refined topics, ML analytics, and actionable recommendations.

## Database Schema Changes

### New Tables Added

#### 1. `topic_definitions` (ML-generated, raw)
- Contains raw topic modeling output from BERTopic
- Fields: topic_id, topic_name, topic_label, keywords, representative_texts
- **Issue**: Topics are messy with hashtags like "#الفاشر_تباد"

#### 2. `topic_definitions_refined` (LLM-enhanced) ⭐
- Contains cleaned, categorized topics processed by GPT-4
- **Primary source for all topic data**
- Fields:
  - `refined_name`: Clean, readable topic name (e.g., "Al Fashir Massacre Awareness")
  - `category`: High-level category (e.g., "Humanitarian Crisis")
  - `subcategory`: Specific subcategory
  - `monitoring_priority`: high | medium | low | ignore
  - `recommended_actions`: Machine-readable monitoring instructions
  - `quality_score`: Topic quality (0-1)
  - `relevance_to_project`: Relevance to Sudan-UAE monitoring (0-1)

#### 3. `tweet_topics`
- Links tweets to topics with probability scores
- Fields: tweet_id, topic_id, probability, is_outlier

#### 4. `author_topics`
- Tracks author expertise in topics
- Fields: author_id, topic_id, tweet_count, avg_probability, total_engagement

#### 5. `topic_evolution`
- Hourly metrics for topic trends (populated via preprocessing script)
- Fields: topic_id, date, hour, tweet_count, growth_rate, viral_tweets

### Environment Variables Added
```bash
TOPIC_DEFINITIONS_TABLE=topic_definitions
TOPIC_DEFINITIONS_REFINED_TABLE=topic_definitions_refined
TWEET_TOPICS_TABLE=tweet_topics
AUTHOR_TOPICS_TABLE=author_topics
TOPIC_EVOLUTION_TABLE=topic_evolution
```

## API Structure

### 1. Topics Router (`/api/v1/topics`) - PRIMARY
**Purpose**: Access refined topics with actionable recommendations

#### Endpoints:
- `GET /api/v1/topics/refined` - List refined topics with filters
- `GET /api/v1/topics/refined/{topic_id}` - Get single refined topic
- `GET /api/v1/topics/by-category` - Topics grouped by category
- `GET /api/v1/topics/actionable` - Topics with monitoring actions
- `GET /api/v1/topics/search` - Search topics
- `GET /api/v1/topics/statistics` - Topic statistics
- `GET /api/v1/topics/{topic_id}/comparison` - Compare raw vs refined

#### Key Features:
- **ALWAYS uses topic_definitions_refined** (never raw)
- Returns clean topic names, not hashtags
- Includes machine-readable monitoring actions:
```json
{
  "action_type": "add_query",
  "query": "Sudan RSF attacks civilians",
  "frequency": "real-time",
  "reason": "Critical humanitarian crisis"
}
```

### 2. Topic Analytics Router (`/api/v1/topic-analytics`)
**Purpose**: Analytics on topic relationships and trends

#### Endpoints:
- `GET /api/v1/topic-analytics/theme-topics` - Topics appearing in themes
- `GET /api/v1/topic-analytics/author-expertise` - Find topic experts
- `GET /api/v1/topic-analytics/evolution-trends` - Track topic growth

#### Key Features:
- Links topics to themes via tweet collections
- Identifies influential authors per topic
- Computes trends on-the-fly if topic_evolution is empty

## Repository Pattern

### TopicRepository (`app/repositories/topic_repository.py`)
- Handles all refined topic operations
- Primary methods:
  - `get_refined_topics()` - Filter by category, priority, quality
  - `get_actionable_topics()` - Topics with monitoring actions
  - `get_topics_by_category()` - Grouped view
  - `get_topic_statistics()` - Overall metrics

### TopicAnalyticsRepository (`app/repositories/topic_analytics.py`)
- Handles cross-table analytics
- Primary methods:
  - `get_topic_theme_analytics()` - Topic-theme relationships
  - `get_author_expertise()` - Author-topic expertise
  - `get_topic_evolution_trends()` - Time-based trends

## Preprocessing Scripts

### Topic Refinement (`/scripts/topic_refinement/`)
- `refine_topics.py` - Main script for LLM processing
- `llm_analyzer.py` - OpenAI GPT-4 integration
- `database.py` - Database operations
- Processes raw topics → refined topics with categories and actions

### Topic Evolution (`/scripts/topic_evolution/`)
- `compute_evolution.py` - Populates topic_evolution table
- Computes hourly metrics: tweet volume, growth rate, viral content
- Run modes: `--incremental` or `--days 30`

## Data Flow

1. **Raw Topics** (topic_definitions)
   - Generated by ML model (BERTopic)
   - Messy, hashtag-heavy

2. **LLM Refinement** (scripts)
   - Process with GPT-4
   - Clean names, categorize, generate actions
   - Store in topic_definitions_refined

3. **API Access**
   - Topics router: Access refined topics
   - Topic analytics router: Cross-table analytics
   - **ALWAYS use refined data**

## Best Practices for MCP Agent

### When to Use Each Endpoint

#### For Topic Information:
- Use `/api/v1/topics/refined` - Get clean topic list
- Use `/api/v1/topics/actionable` - Get monitoring recommendations
- Use `/api/v1/topics/by-category` - Understand topic landscape

#### For Analytics:
- Use `/api/v1/topic-analytics/theme-topics` - Topic-theme relationships
- Use `/api/v1/topic-analytics/author-expertise` - Find influencers
- Use `/api/v1/topic-analytics/evolution-trends` - Track momentum

### Key Points:
1. **NEVER use raw topic_definitions** - Always use refined
2. **Actionable recommendations** are in `recommended_actions` field
3. **Priority levels**: high > medium > low > ignore
4. **Quality metrics**: quality_score and relevance_to_project (0-1)

## Example Usage

### Get high-priority topics with actions:
```bash
GET /api/v1/topics/actionable?limit=10
```

### Find topic experts:
```bash
GET /api/v1/topic-analytics/author-expertise?topic_id=26&min_tweet_count=10
```

### Track trending topics:
```bash
GET /api/v1/topic-analytics/evolution-trends?hours=24&min_growth_rate=0.5
```

## Summary of Changes

### Added:
- 5 new database models
- 2 new routers (topics, topic_analytics)
- 2 new repositories
- 2 preprocessing scripts
- Complete LLM refinement pipeline

### Removed:
- Redundant recommendations endpoints in topic_analytics
- Duplicate methods in repositories

### Key Improvement:
- All topic data now comes from refined source
- Machine-readable monitoring actions
- Clean, categorized topics instead of raw hashtags